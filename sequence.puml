@startuml
actor "Браузер (Сайт клиента)" as BrowserClient
actor "Браузер (Страницы Яндекса)" as BrowserYandex
participant "SmartisTrackerModule\n(https://tracker.smartcallback.ru)" as Smartis
participant "SmartisPostviewModule" as SmartisPV
participant "YandexMapModule\n(https://an.yandex.ru)" as YandexMap
participant "YandexVerifyModule\n(https://verify.yandex.ru)" as YandexVerify
database "YandexPostview_table\n(postview.yandex_views)" as DB

== Сценарий 1: Матчинг на нашем трафике ==
group 1. Пиксель на сайте застройщика
    BrowserClient -> Smartis : Загружает пиксель (SmartCallback)
    activate Smartis
    Smartis -> Smartis : Проверка pid в куках
    alt pid отсутствует
        Smartis -> Smartis : POST /pid/create
        Smartis --> Smartis : Возвращает новый pid
    end
    Smartis --> BrowserClient : Пиксель прогружен (с pid)
    deactivate Smartis

    BrowserClient -> YandexMap : GET /mapuid/<CookieMatchTag>/pid
    activate YandexMap
    YandexMap --> BrowserClient : Ответ от YandexMapModule
    deactivate YandexMap
end

== Сценарий 2: Матчинг на трафике Яндекса ==
group 2. Matching через Яндекс
    BrowserYandex -> Smartis : GET /matching
    activate Smartis
    Smartis -> Smartis : Проверка pid в куках
    alt pid отсутствует
        Smartis -> Smartis : POST /pid/create
        Smartis --> Smartis : Возвращает новый pid
    end
    Smartis --> BrowserYandex : 302 Redirect\nLocation: https://an.yandex.ru/mapuid/<CookieMatchTag>/pid
    deactivate Smartis
end

== Сценарий 3: Фиксация просмотров ==
group 3. Просмотр рекламного объявления
    BrowserYandex -> YandexVerify : GET /verify_smartis/verify?param1=1&param2=2...
    activate YandexVerify
    YandexVerify -> YandexVerify : Идентификация PARTNER_NAME = Smartis
    YandexVerify -> Smartis : GET /show?param1=1&param2=2...&Yandexuid=XXXX&ExtUID=pid\nHeaders:\n- User-Agent\n- X-Yabs-Request-Id\n- X-Forwarded-For (IP без последнего октета)
    activate Smartis
    Smartis ->  SmartisPV: POST /postviews/show/yandex-direct
    activate SmartisPV
    SmartisPV --> Smartis: 200 OK
    deactivate SmartisPV
    Smartis --> YandexVerify : 200 OK
    deactivate Smartis
    YandexVerify --> BrowserYandex : 200 OK (пиксель завершён)
    deactivate YandexVerify
end

@enduml